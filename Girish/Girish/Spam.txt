https://www.google.com/amp/s/arunkrishlinux.wordpress.com/2015/08/10/checking-email-logs-in-cpanel-cent-os-for-tracking-spamming-and-spoofing-activities/amp/

https://www.inmotionhosting.com/support/email/exim/find-spam-script-location-with-exim




# exim -bpc

If you can see too many mails in the queue, you are lucky. You can find the spammer so easily.

Say, if you are seeing a count above 100 or larger, use the below command. This script will show in ascending order, the mails in queue from/to a email address

For eg :

# exim -bpr | grep “<*@*>” | awk ‘{print $4}’|grep -v “<>” | sort | uniq -c | sort -n
1 <edson@server.com>
1 <phahlamohlakak@domain.com>
2 <sukazim@domain.com>
4 <mcrscxuo@domain.com>
6 <khanyilen@domain.com>
1322 <admin@domain.com>

See, if you are seeing mails in queue from different email addresses of the same domain. This applies, if the email address you found above doesn’t exists also ( spoofing ).

# This will show in ascending order, the number of emails currently in the mail queue from/to a domain

exim -bpr | grep “<*@*>” | awk ‘{print $4}’|grep -v “<>” |awk -F “@” ‘{ print $2}’ | sort | uniq -c | sort -n

eg:

exim -bpr | grep “<*@*>” | awk ‘{print $4}’|grep -v “<>” |awk -F “@” ‘{ print $2}’ | sort | uniq -c | sort -n
1 domain.com>
1 domain.com>
2263  domain.com>

You can see that the spamming is from the domain example.com, but couldn’t find the correct email address. Here, you need to check the mail headers.

Check the headers and body of the mail from the queue.

Take a sample mail from the particular domain from which you are seeing too many mails.

exim -bp | grep domain_name | head

Take the ID and use the below command to see the headers:

exim -Mvh <Message _id >
For eg:

exim -Mvh 1UsO1h-0003Yc-Un
———

See the below lines in the mail headers:

-host_auth dovecot_login
-auth_id

will show the senders or user account from which the mails are being sent. If it is a email address reset that password. Otherwise if it is the cPanel account name ( default email address with cPanel ) reset the cPanel user password.

For eg:

exim -Mvh 1Usuv7-0007Em-Kh
1Usuv7-0007Em-Kh-H
mailnull 47 12
<sales@domain.co.za>
1372511429 0
-helo_name holxqaexil
-host_address 183.13.246.43.25212
-host_auth dovecot_login
-interface_address 196.33.227.144.25
-received_protocol esmtpa
-body_linecount 29
-max_received_linelength 77
-auth_id sales@domain.co.za
-host_lookup_failed

In the above example host_auth is dovecot_login and auth_id sales@domain.co.za. This means the mails are sent after authentication and the spammer is sales@doamin.co.za.

After resetting the password, please don’t forget to restart Exim.

/etc/init.d/exim restart

I had troubles before, since I din’t restart exim and the spamming continued even after resetting password. Restarting exim will kill all the active sessions.

Suppose, you are not seeing an authenticated email address from the headers

For eg:
root@server [/var/spool/exim/input]# exim -Mvh 1UsuMJ-0001cR-CS
1UsuMJ-0001cR-CS-H
deadzwzc 505 505
<admin@domain.com>
1372509271 0
-ident deadzwzc
-received_protocol local
-body_linecount 11
-max_received_linelength 130
-auth_id deadzwzc
-auth_sender deadzwzc@domain.com
-allow_unqualified_recipient
-allow_unqualified_sender
-local
-sender_set_untrusted

Here, there is auth_sender, but no host_auth, showing the mail is sent after authentication. This means the mail is sent from a PHP mailer script. Scroll down the page and look for the line X-PHP-Script or X-Mailer:

X-PHP-Script: shows the PHP script and the IP address, if the mail has been sent using a PHP script in the server.
X-Mailer: PHPMailer 5.2 (http://code.google.com/a/apache-extras.org/p/phpmailer/)

Mails are sent from the user nobody, or the default email address of cPanel user. Here resetting password, will not work, since the mails are sent without authentication using the PHP script.

You can check the complete mail queue as below:

cd /var/spool/exim/input
egrep “X-PHP-Script” * -R

eg:
# egrep “X-PHP-Script” * -R
0/1RLcq0-0007wU-Fr-H:078 X-PHP-Script: 67.222.8.186/~emaillis/lists/admin/index.php for 175.136.240.94
0/1RLfT0-0005p5-7O-H:078 X-PHP-Script: 67.222.8.186/~emaillis/lists/admin/index.php for 175.136.240.94

Disable that script by changing the ownership to root and permissions to 000. Please always change the ownership to root, since the hacker who was able to upload files to the user account would be knowing the user password and can change the permissions back and continue using the script. You can better reset the cPanell/FTP password also ??

See, if you are not seeing any mails in the queue ( You won’t get any alerts in this case ?? ). I just want to tell how you can find the spammer in case of past spamming.

If the spamming has happened some hours before using a PHP script, use the following command.

Command :
grep “cwd=” /var/log/exim_mainlog|awk ‘{for(i=1;i<=10;i++){print $i}}’|sort|uniq -c|grep cwd|sort -n

Example :

47 cwd=/root
8393 cwd=/home/sample/public_html/test

Count the cwd and if it is a large value check the files in the directory listed in cwd
(Ignore if it is / or /var/spool/mail /var/spool/exim)

If you are not finding any mail script by just looking in the directory, check the domlogs. Check the exact time at which the mail are sent using that script from the exim logs. Check the domlogs of that domain at that particular time. Check for the POST at that time, will give you the exact URL from which the mails are being sent.

Clearing the Mails ?? ??
———–
– Mails from a particular sender
exiqgrep -i -f user@domain.com | xargs exim -Mrm

– To clear mails from Exim Queue for which recipient cannot not be verified.
grep -R -l ‘The recipient cannot be verified’ /var/spool/exim/msglog/*|cut -b26-|xargs exim -Mrm

– To clear frozen mails from Exim Queue.
grep -R -l ‘*** Frozen’ /var/spool/exim/msglog/*|cut -b26-|xargs exim -Mrm

– To clear spam mails from Exim Queue.
grep -R -l [SPAM] /var/spool/exim/msglog/*|cut -b26-|xargs exim -Mrm

– Remove root mails from the queue.
exim -bp |grep “<root@HOSTNAME>”|awk ‘{print $3}’|xargs exim -Mrm
Replace “HOSTNAME” with server hostname
————-

Even if you feel its too long KB, its not complete for finding the spammer. Anyways, it will work for fixing our spam alerts, since alerts will come for only current spamming, no past spamming.

One more thing. You are seeing large number of mails on checking via exim -bpc. But, when you check

exim -bpr | grep “<*@*>” | awk ‘{print $4}’|grep -v “<>” |awk -F “@” ‘{ print $2}’ | sort | uniq -c | sort -n

You are not seeing that big number. For eg:

—–
root@server.com [~]# exim -bpc
2595

root@server [~]# exim -bpr | grep “<*@*>” | awk ‘{print $4}’|grep -v “<>” | sort | uniq -c | sort -n
1 <bounces@hsaag-dommm.co.za>
1 <ipact@badassh-idpa-padsacc1.telkosdm-ipnsset.co.za>
1 <litigasie3@domain.co.za>
—–

Here, the mails are frozen. You can check this using:

exim -bp |grep frozen | wc -l

—–
root@ebmcomputersptyltd [~]# exim -bp |grep frozen | wc -l
2156
—–

You can delete the frozen mails using the command.
grep -R -l ‘*** Frozen’ /var/spool/exim/msglog/*|cut -b26-|xargs exim -Mrm

To delete the bounces like “mail delivery failed”
grep -R -l ‘Mail delivery failed: returning message to sender’ /var/spool/exim/msglog/*|cut -b26-|xargs exim -Mrm
Also, on checking the headers you are seeing X-Mailer in the headers, instead of X-PHP-Script:

082 X-Mailer: PHPMailer 5.2 (http://code.google.com/a/apache-extras.org/p/phpmailer/)

Its just a PHP mailer. You are not able to find the script. Then also, please check the domlogs of domain that at particular time.

For eg:

————
213P Received: from doubluol by bigdaddy2.co.za with local (Exim 4.80)
(envelope-from <werner@domain.co.za>)
id 1Ut2aF-0004zU-Kh
for b.bbn.v.nvn.vnn.vnv.nj449@gmail.com; Sat, 29 Jun 2013 23:21:27 +0200
040T To: b.bbn.v.nvn.vnn.vnv.nj449@gmail.com
076 Subject: Account Details for hopojuhzscymfbjcpcvwvtxghel at Double-U Design
038 Date: Sat, 29 Jun 2013 23:21:27 +0200
040* Return-Path: werner@domain.co.za
051F From: Double-U Design <werner@domain.co.za>
055R Reply-to: Double-U Design <werner@domain.co.za>
071I Message-ID: <437770ba85b9493221d1c30ff55650ca@www.domain.co.za>
014 X-Priority: 3
082 X-Mailer: PHPMailer 5.2 (http://code.google.com/a/apache-extras.org/p/phpmailer/)
018 MIME-Version: 1.0
032 Content-Transfer-Encoding: 8bit
042 Content-Type: text/plain; charset=”utf-8?
————

In the above mail header its shows the mails are sent using the PHP mailer function of domain domain.co.za. Check the domlogs at that time.
————
root@bigdaddy [/u1/home/domain/public_html/double]# grep POST /usr/local/apache/domlogs/domain.co.za | grep 29/Jun/2013:23:21
222.247.36.186 – – [29/Jun/2013:23:21:27 +0200] “POST /double/index.php/component/users/ HTTP/1.1” 303 20 “http://www.domain.co.za/double/index.php/component/users/?view=registration&#8221; “Mozilla/5.0 (Windows NT 5.1; rv:19.0) Gecko/20100101 Firefox/19.0”
222.247.36.186 – – [29/Jun/2013:23:21:37 +0200] “POST /double/index.php/component/users/ HTTP/1.1” 303 20 “http://www.domain.co.za/double/index.php/component/users/?view=registration&#8221; “Mozilla/5.0 (Windows NT 5.1; rv:19.0) Gecko/20100101 Firefox/19.0”
————

I could see that the registration form in the site is used for sending spam mails 


=========================================================
Run the following command to pull the most used mailing script's location from the Exim mail log:
grep cwd /var/log/exim_mainlog | grep -v /var/spool | awk -F"cwd=" '{print $2}' | awk '{print $1}' | sort | uniq -c | sort -n

You should get back something like this:

15 /home/userna5/public_html/about-us
25 /home/userna5/public_html
7866 /home/userna5/public_html/data

We can see /home/userna5/public_html/data by far has more deliveries coming in than any others.

Now we can run the following command to see what scripts are located in that directory:
ls -lahtr /userna5/public_html/data

In thise case we got back:

drwxr-xr-x 17 userna5 userna5 4.0K Jan 20 10:25 ../
-rw-r--r-- 1 userna5 userna5 5.6K Jan 20 11:27 mailer.php
drwxr-xr-x 2 userna5 userna5 4.0K Jan 20 11:27 ./

So we can see there is a script called mailer.php in this directory

Knowing the mailer.php script was sending mail into Exim, we can now take a look at our Apache access log to see what IP addresses are accessing this script using the following command:
grep "mailer.php" /home/userna5/access-logs/example.com | awk '{print $1}' | sort -n | uniq -c | sort -n

You should get back something similar to this:

2 123.123.123.126
2 123.123.123.125
2 123.123.123.124
7860 123.123.123.123

We can see the IP address 123.123.123.123 was using our mailer script in a malicious nature.

If you find a malicious IP address sending a large volume of mail from a script, you'll probably want to go ahead and block them at your server's firewall so that they can't try to connect again.

This can be accomplished with the following command:

apf -d 123.123.123.123 "Spamming from script in /home/userna5/public_html/data"

Hopefully you've learned how to use your Exim mail log to see what scripts on your server are causing the most email activity. Also how to investigate if malicious activity is going on, and how to block it.